{% assign product = closest.product %}

{% comment %} Check for custom badges via product tags {% endcomment %}
{% assign has_trial_badge = false %}
{% assign has_bogo_badge = false %}
{% assign has_bestseller_badge = false %}

{% comment %} Check for TRIAL badge - via product tag {% endcomment %}
{% if product.tags contains 'trial' or product.tags contains 'TRIAL' %}
  {% assign has_trial_badge = true %}
{% endif %}

{% comment %} Check for BOGO badge - via product tag {% endcomment %}
{% if product.tags contains 'bogo' or product.tags contains 'BOGO' %}
  {% assign has_bogo_badge = true %}
{% endif %}

{% comment %} Check for BEST SELLER badge - via product tag {% endcomment %}
{% if product.tags contains 'bestseller' or product.tags contains 'BEST SELLER' or product.tags contains 'best-seller' or product.tags contains 'best seller' %}
  {% assign has_bestseller_badge = true %}
{% endif %}

{% capture children %}
  {% unless product == blank %}
    <div
      class="product-badges product-badges--{{ settings.badge_position }}"
      style="
        --badge-border-radius: {{ settings.badge_corner_radius }}px;
        --badge-font-family: var(--font-{{ settings.badge_font_family }}--family); --badge-font-weight: var(--font-{{ settings.badge_font_family }}--weight); --badge-text-transform: {{ settings.badge_text_transform }};
      "
    >
      {% comment %} Priority order: Sold Out > Sale > Trial > BOGO > Best Seller {% endcomment %}
      {%- if product.available == false -%}
        <div
          class="product-badges__badge product-badges__badge--rectangle color-{{ settings.badge_sold_out_color_scheme }}"
        >
          {{ 'content.product_badge_sold_out' | t }}
        </div>
      {%- elsif product.compare_at_price > product.price -%}
        <div
          class="product-badges__badge product-badges__badge--rectangle color-{{ settings.badge_sale_color_scheme }}"
        >
          {{ 'content.product_badge_sale' | t }}
        </div>
      {%- elsif has_trial_badge -%}
        <div
          class="product-badges__badge product-badges__badge--rectangle product-badges__badge--trial"
        >
          TRIAL
        </div>
      {%- elsif has_bogo_badge -%}
        <div
          class="product-badges__badge product-badges__badge--rectangle product-badges__badge--bogo"
        >
          BOGO
        </div>
      {%- elsif has_bestseller_badge -%}
        <div
          class="product-badges__badge product-badges__badge--rectangle product-badges__badge--bestseller"
        >
          BEST SELLER
        </div>
      {%- endif -%}
    </div>
    {%  if settings.quick_add or settings.mobile_quick_add %}
      {% render 'quick-add', product: product, section_id: section.id %}
    {% endif %}
  {% endunless %}
{% endcapture %}

{% render 'card-gallery', children: children %}

{% # Title and price for the zoomed out grid view %}
<div class="product-grid-view-zoom-out--details">
  {% if product == blank %}
    <h3 class="h4">{{ 'content.product_card_placeholder' | t }}</h3>
  {% else %}
    <h3 class="h4">{{ product.title }}</h3>
  {% endif %}
</div>

{% comment %} JavaScript to dynamically add BOGO badges based on active campaigns {% endcomment %}
{% unless product == blank %}
  <script>
    (function() {
      'use strict';
      
      {% comment %} Get BOGO campaigns from metafield {% endcomment %}
      const bogoCampaignsEl = document.getElementById('bogo-campaigns');
      if (!bogoCampaignsEl) return;
      
      try {
        const campaigns = JSON.parse(bogoCampaignsEl.textContent) || [];
        const activeCampaigns = campaigns.filter(c => c.enabled);
        
        {% comment %} Extract product ID from Shopify GID {% endcomment %}
        const productId = '{{ product.id }}';
        const productIdNum = productId.split('/').pop();
        
        {% comment %} Check if this product is in any active BOGO campaign {% endcomment %}
        let isInBogo = false;
        for (const campaign of activeCampaigns) {
          if (campaign.products && campaign.products.length > 0) {
            for (const campaignProduct of campaign.products) {
              const campaignProductId = String(campaignProduct.id).split('/').pop();
              if (campaignProductId === productIdNum) {
                isInBogo = true;
                break;
              }
            }
          }
          if (isInBogo) break;
        }
        
        {% comment %} If product is in BOGO and doesn't already have a badge, add BOGO badge {% endcomment %}
        if (isInBogo) {
          const badgesContainer = document.querySelector('#product-card-{{ block.id }} .product-badges');
          if (badgesContainer) {
            {% comment %} Only add if no other badge is showing (sold out or sale take priority) {% endcomment %}
            const existingBadge = badgesContainer.querySelector('.product-badges__badge');
            if (!existingBadge) {
              const bogoBadge = document.createElement('div');
              bogoBadge.className = 'product-badges__badge product-badges__badge--rectangle product-badges__badge--bogo';
              bogoBadge.textContent = 'BOGO';
              badgesContainer.appendChild(bogoBadge);
            }
          }
        }
      } catch (error) {
        console.log('Error checking BOGO campaigns:', error);
      }
    })();
  </script>
{% endunless %}

{% stylesheet %}
  .product-badges {
    --badge-inset: max(var(--padding-xs), calc((var(--border-radius) + var(--padding-xs)) * (1 - cos(45deg))));

    position: absolute;
    z-index: var(--layer-flat);
  }

  .product-badges--bottom-left {
    bottom: calc(var(--badge-inset) + var(--padding-block-start));
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--top-left {
    top: calc(var(--badge-inset) + var(--padding-block-start));
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--top-right {
    top: calc(var(--badge-inset) + var(--padding-block-start));
    right: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges__badge {
    --badge-font-size: var(--font-size--xs);

    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--color-foreground);
    background: var(--color-background);
    font-size: var(--badge-font-size);
    font-family: var(--badge-font-family);
    font-weight: var(--badge-font-weight);
    text-transform: var(--badge-text-transform);
    border-radius: var(--badge-border-radius);
  }

  .product-badges__badge--rectangle {
    padding-block: var(--badge-rectangle-padding-block);
    padding-inline: var(--badge-rectangle-padding-inline);
  }

  .product-badges__badge--trial {
    background: rgb(var(--color-button));
    color: rgb(var(--color-button-text));
  }

  .product-badges__badge--bogo {
    background: rgb(var(--color-success));
    color: rgb(var(--color-success-text));
  }

  .product-badges__badge--bestseller {
    background: rgb(var(--color-accent));
    color: rgb(var(--color-accent-text));
  }
{% endstylesheet %}

{% schema %}
{
  "name": "t:names.product_image",
  "tag": null,
  "settings": [
    {
      "type": "paragraph",
      "content": "t:content.resource_reference_product_media"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "t:options.auto"
        },
        {
          "value": "portrait",
          "label": "t:options.portrait"
        },
        {
          "value": "square",
          "label": "t:options.square"
        },
        {
          "value": "landscape",
          "label": "t:options.landscape"
        }
      ],
      "default": "portrait",
      "label": "t:settings.aspect_ratio",
      "info": "t:info.aspect_ratio_adjusted"
    },
    {
      "type": "header",
      "content": "t:content.borders"
    },
    {
      "type": "select",
      "id": "border",
      "label": "t:settings.style",
      "options": [
        {
          "value": "none",
          "label": "t:options.none"
        },
        {
          "value": "solid",
          "label": "t:options.solid"
        }
      ],
      "default": "none"
    },
    {
      "type": "range",
      "id": "border_width",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "t:settings.thickness",
      "default": 1,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_opacity",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "t:settings.opacity",
      "default": 100,
      "visible_if": "{{ block.settings.border != 'none' }}"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "t:settings.border_radius",
      "min": 0,
      "max": 32,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "t:settings.left",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "t:settings.right",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "t:names.product_card_media",
      "category": "t:categories.product"
    }
  ]
}
{% endschema %}
