<script
  type="module"
  src="{{ 'cart-icon.js' | asset_url }}"
  fetchpriority="low"
></script>

{% capture cart_icon %}
  <cart-icon
    class="
      header-actions__cart-icon
      {% unless cart == empty %} header-actions__cart-icon--has-cart{% endunless %}
    "
    data-testid="cart-icon"
  >
    <span
      class="svg-wrapper"
      aria-hidden="true"
    >
      {{ 'icon-cart.svg' | inline_asset_content }}
    </span>

    {% render 'cart-bubble', limit: 100, live_region: true, test_id: test_id %}
  </cart-icon>
{% endcapture %}

<header-actions
  {{- block.shopify_attributes -}}
>
  {% if shop.customer_accounts_enabled %}
    <script
      src="{{ 'dialog.js' | asset_url }}"
      type="module"
    ></script>

    <anchored-popover-component
      data-close-on-resize="true"
      class="account-popover mobile:hidden"
    >
      {% render 'account-button' with 'account-popover' as popover_id %}
      <div
        class="account-popover__panel details-content color-{{ settings.popover_color_scheme }}"
        id="account-popover"
        popover="auto"
        ref="popover"
      >
        {% render 'account-actions' %}
      </div>
    </anchored-popover-component>

    <dialog-component
      class="account-drawer"
      {{ block.shopify_attributes }}
    >
      {% render 'account-button', attributes: 'on:click="/showDialog"' %}
      <dialog
        ref="dialog"
        class="color-{{ settings.popover_color_scheme }} dialog-modal dialog-drawer dialog-bottom-sheet account-drawer__dialog"
        scroll-lock
        aria-labelledby="account-drawer-heading"
      >
        <button
          ref="closeButton"
          on:click="/closeDialog"
          class="button button-unstyled close-button account-drawer__close-button"
          aria-label="{{ 'actions.close_dialog' | t }}"
          autofocus
        >
          <span
            class="svg-wrapper"
            aria-hidden="true"
          >
            {{- 'icon-close.svg' | inline_asset_content -}}
          </span>
        </button>
        {% render 'account-actions' %}
      </dialog>
    </dialog-component>
  {% endif %}

  {% if settings.cart_type == 'drawer' and template.name != 'cart' %}
    <script
      src="{{ 'cart-drawer.js' | asset_url }}"
      type="module"
      fetchpriority="low"
    ></script>

    <cart-drawer-component
      class="cart-drawer"
      {{ block.shopify_attributes }}
      {% if settings.auto_open_cart_drawer %}
        auto-open
      {% endif %}
    >
      <button
        class="button header-actions__action button-unstyled"
        on:click="/open"
        aria-haspopup="dialog"
        aria-label="{{ 'accessibility.cart' | t }}"
        aria-describedby="cart-bubble-text"
        data-testid="cart-drawer-trigger"
      >
        {{ cart_icon }}
      </button>

      <dialog
        ref="dialog"
        class="cart-drawer__dialog dialog-modal dialog-drawer color-{{ settings.drawer_color_scheme }}{% if cart.empty? %} cart-drawer--empty{%endif%}"
        aria-labelledby="{% if cart.empty? %}cart-drawer-heading-empty{% else %}cart-drawer-heading{% endif %}"
        scroll-lock
        cart-summary-sticky="true"
      >
        <div class="cart-drawer__inner">
          <cart-items-component
            class="cart-items-component"
            data-section-id="{{ section.id }}"
          >
            {%- if cart.empty? -%}
              <div class="cart-drawer__header">
                <button
                  ref="closeButton"
                  on:click="cart-drawer-component/close"
                  class="button close-button cart-drawer__close-button button-unstyled"
                  aria-label="{{ 'actions.close_dialog' | t }}"
                >
                  <span class="svg-wrapper">
                    {{- 'icon-close.svg' | inline_asset_content -}}
                  </span>
                </button>
              </div>

              <div
                class="cart-drawer__content motion-reduce"
                aria-label="{{ 'accessibility.cart' | t }}"
              >
                <h2
                  class="cart-drawer__heading h4 cart-drawer__heading--empty"
                  id="cart-drawer-heading-empty"
                >
                  {{ 'content.your_cart_is_empty' | t }}
                </h2>

                <div class="cart-drawer__items">
                  {% render 'cart-products', drawer_context: 'drawer' %}
                </div>
              </div>
            {%- else -%}
              <div
                class="cart-drawer__header"
                id="cart-drawer-header"
              >
                <h2
                  class="cart-drawer__heading h4"
                  id="cart-drawer-heading"
                >
                  {{ 'content.cart_title' | t }}
                  {% render 'cart-bubble' %}
                </h2>

                <button
                  ref="closeButton"
                  on:click="cart-drawer-component/close"
                  class="button close-button cart-drawer__close-button button-unstyled"
                  aria-label="{{ 'actions.close_dialog' | t }}"
                >
                  <span class="svg-wrapper">
                    {{- 'icon-close.svg' | inline_asset_content -}}
                  </span>
                </button>
              </div>

              <scroll-hint
                class="cart-drawer__content motion-reduce"
                aria-label="{{ 'accessibility.cart' | t }}"
                style="--header-height: 60px;"
              >
                {% comment %} Free Shipping Bar in Cart Drawer {% endcomment %}
                {% assign shipping_threshold = shop.metafields.shipping.free_threshold | default: 50 %}
                {% assign shipping_message = shop.metafields.shipping.message | default: 'Add {amount} more for free shipping!' %}
                {% assign shipping_success_message = shop.metafields.shipping.success_message | default: 'You qualify for free shipping!' %}
                
                <div class="cart-drawer__shipping-bar" id="cart-drawer-shipping-bar">
                  <div class="cart-drawer__shipping-content">
                    <div class="cart-drawer__shipping-progress">
                      <div class="cart-drawer__shipping-progress-fill" id="cart-shipping-progress-fill"></div>
                    </div>
                    <div class="cart-drawer__shipping-message" id="cart-shipping-message"></div>
                  </div>
                </div>
                
                <scroll-hint
                  class="cart-drawer__items"
                >
                  {% render 'cart-products', drawer_context: 'drawer' %}
                </scroll-hint>

                <div
                  class="cart-drawer__summary"
                >
                  {% render 'cart-summary' %}
                </div>
              </scroll-hint>
            {%- endif -%}
          </cart-items-component>
        </div>
      </dialog>
    </cart-drawer-component>
  {% else %}
    <a
      href="{{ routes.cart_url }}"
      class="header-actions__action action__cart"
      aria-label="{{ 'accessibility.cart' | t }}"
      aria-describedby="cart-bubble-text"
    >
      {{ cart_icon }}
    </a>
  {% endif %}
</header-actions>

{% stylesheet %}
  .account-popover {
    --account-popover-min-width: 22rem;
    --account-actions-max-width: 22rem;
  }

  .account-popover__summary {
    padding: 0;

    &:hover {
      color: var(--color-foreground);
    }
  }

  .account-popover__panel {
    --account-popover-opacity: 0;
    --account-popover-y: 20px;

    position-anchor: --account-button-trigger;
    border-radius: var(--style-border-radius-popover);
    margin: 0;
    left: unset;
    width: max-content;
    min-width: var(--account-popover-min-width);
    box-shadow: var(--shadow-popover);
    border: var(--style-border-popover);
    background-color: var(--color-background);
    overflow-y: hidden;
    opacity: var(--account-popover-opacity);
    translate: 0 var(--account-popover-y);
    transition-property: display, opacity, translate;
    transition-duration: 0.3s;
    transition-timing-function: var(--ease-out-quad);
    transition-behavior: allow-discrete;
    top: calc(anchor(bottom) + var(--header-padding));
    right: anchor(right);

    &:popover-open {
      --account-popover-opacity: 1;
      --account-popover-y: 0px;
    }

    @supports not (position-anchor: --account-button-trigger) {
      top: calc(var(--anchor-top) * 1px + var(--minimum-touch-target) + var(--header-padding));
      right: calc(var(--anchor-right) * 1px);
    }

    @supports not selector(:popover-open) {
      &.\:popover-open {
        --account-popover-opacity: 1;
        --account-popover-y: 0px;
      }
    }
  }

  @starting-style {
    .account-popover__panel {
      --account-popover-opacity: 0.7;
      --account-popover-y: 20px;
    }

    .account-popover__panel:popover-open {
      --account-popover-opacity: 0.7;
      --account-popover-y: 20px;
    }
  }

  .account-drawer {
    @media screen and (min-width: 750px) {
      display: none;
    }
  }

  .account-drawer__dialog {
    --animation-speed: 0.24s;
    --dialog-drawer-opening-animation: move-and-fade;
    --dialog-drawer-closing-animation: move-and-fade;

    height: fit-content;
    margin: 0;
    inset-block-end: 0;
    inset-block-start: auto;
    border-radius: 0;
    padding: 0;
  }

  .dialog-drawer.account-drawer__dialog[open] {
    --start-x: 0px;
    --end-x: 0px;
    --start-y: 100%;
    --start-opacity: 1;
  }

  .dialog-drawer.account-drawer__dialog.dialog-closing {
    --start-x: 0px;
    --end-x: 0px;
    --end-y: 100%;
    --start-opacity: 1;
  }

  .account-drawer__close-button {
    z-index: 1;
    inset-block-start: var(--padding-xs);
    inset-inline-end: var(--padding-xs);
    color: var(--color-foreground);
    background-color: transparent;
  }

  .account-drawer__close-button .svg-wrapper {
    display: flex;
    width: var(--button-size);
    height: var(--button-size);
    align-items: center;
    justify-content: center;
  }

  @keyframes account-drawer-slide-in {
    from {
      transform: translateY(100%);
    }

    to {
      transform: translateY(0);
    }
  }

  @keyframes account-drawer-slide-out {
    from {
      transform: translateY(0);
    }

    to {
      transform: translateY(100%);
    }
  }

  .cart-drawer {
    --cart-drawer-padding: var(--padding-lg) var(--padding-xl);
    --cart-drawer-padding-desktop: var(--padding-xl) var(--padding-2xl);
    --cart-font-size--2xs: var(--font-size--2xs);
    --cart-font-size--xs: var(--font-size--xs);
    --cart-font-size--sm: var(--font-size--sm);
    --cart-font-size--md: var(--font-size--md);
    --cart-font-size--lg: var(--font-size--lg);
    --cart-font-size--xl: var(--font-size--xl);
    --cart-font-size--2xl: var(--font-size--2xl);
  }

  .cart-drawer__dialog {
    position: fixed;
    overflow: hidden;
    border-radius: 0;
    width: 600px;
    max-width: 95vw;
    height: 100%;
    margin: 0 0 0 auto;
    padding: 0;
    border-left: var(--style-border-drawer);
    box-shadow: var(--shadow-drawer);
    background-color: var(--color-background);
    
    @media screen and (min-width: 750px) {
      width: 650px;
    }
  }

  .cart-items-component {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  /* Needed to ensure the drawer is full height */
  .cart-drawer__dialog:modal {
    max-height: 100dvh;
    overflow-y: hidden;
  }

  .cart-drawer__inner {
    height: 100%;
    overflow: hidden;
  }

  .cart-drawer__content {
    height: calc(100% - var(--header-height));
    display: flex;
    flex-direction: column;
    padding: 0;
    background-color: var(--color-background);
    flex-grow: 1;
    overflow-y: auto;
  }

  .cart-drawer__heading {
    display: flex;
    align-items: center;
    gap: var(--gap-xs);
    margin-bottom: var(--margin-lg);

    @media screen and (max-width: 749px) {
      margin-bottom: 0;
    }
  }

  .cart-drawer__close-button {
    margin-right: calc(var(--padding-sm) * -1);
    top: var(--margin-sm);

    @media screen and (max-width: 749px) {
      top: var(--margin-2xs);
    }
  }

  .cart-drawer--empty .cart-drawer__content {
    text-align: center;
    min-height: auto;
  }

  .cart-drawer--empty .cart-drawer__heading {
    margin-bottom: var(--margin-md);
  }

  .cart-drawer__items .cart-items__table-row {
    padding-bottom: var(--gap-xl);
    border-bottom: var(--style-border-width) solid var(--color-border);
    margin-bottom: var(--gap-xl);
  }

  .cart-drawer__items .cart-items__table-row:has(+ .cart-items__nested-line) {
    border-bottom: none;
    margin-bottom: 0;
  }

  .cart-drawer__items .cart-items__table-row:last-child {
    border-bottom: none;
  }

  .cart-drawer__summary {
    --cart-drawer-summary-padding: var(--padding-lg);

    position: sticky;
    bottom: 0;
    z-index: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--gap-xl);
    padding: var(--cart-drawer-summary-padding);
    margin-top: auto;
    background-color: var(--color-background);
    /* stylelint-disable-next-line color-named */
    mask-image: linear-gradient(to bottom, transparent, black var(--cart-drawer-summary-padding));

    @media screen and (min-width: 750px) {
      --cart-drawer-summary-padding: var(--padding-2xl);
    }
  }

  .cart-drawer__dialog[cart-summary-sticky='false'] .cart-drawer__summary {
    position: static;
    mask-image: none;
  }

  .cart-drawer__dialog[cart-summary-sticky='false'] .cart-drawer__items {
    overflow: unset;
  }

  .cart-actions summary,
  .cart-actions .disclosure-trigger {
    padding-inline: 0;
    padding-block: var(--padding-sm);
    line-height: 1.2;
    min-height: var(--minimum-touch-target);
  }

  .cart-drawer__summary .cart__summary-totals:not(:has(.cart__original-total-container:empty)) {
    border-block-start: var(--style-border-width) solid var(--color-border);
    padding-block-start: var(--padding-2xl);
  }

  .cart-drawer__summary .cart-note {
    @media screen and (min-width: 750px) {
      margin-block-start: var(--margin-3xs);
    }
  }

  .cart-drawer__heading--empty {
    display: flex;
    justify-content: center;
  }

  .cart-drawer__shipping-bar {
    padding: var(--padding-lg) var(--cart-drawer-padding);
    border-bottom: var(--style-border-width) solid var(--color-border);
    background-color: var(--color-background);
    display: none;
    
    @media screen and (min-width: 750px) {
      padding: var(--padding-xl) var(--cart-drawer-padding-desktop);
    }
  }

  .cart-drawer__shipping-content {
    display: flex;
    flex-direction: column;
    gap: var(--gap-md);
  }

  .cart-drawer__shipping-title {
    font-size: var(--font-size--md);
    font-weight: 600;
    color: var(--color-foreground);
    margin: 0;
    line-height: 1.2;
  }

  .cart-drawer__shipping-progress {
    width: 100%;
    height: 10px;
    background: rgb(var(--color-border));
    border-radius: 5px;
    overflow: hidden;
  }

  .cart-drawer__shipping-progress-fill {
    height: 100%;
    background: rgb(var(--color-button));
    border-radius: 5px;
    transition: width 0.3s ease;
    width: 0%;
  }

  .cart-drawer__shipping-message {
    display: flex;
    align-items: center;
    gap: var(--gap-xs);
    font-size: var(--font-size--sm);
    font-weight: 500;
    color: var(--color-foreground);
    line-height: 1.4;
  }

  .cart-drawer__shipping-message--qualified {
    color: rgb(var(--color-success));
  }

  .cart-drawer__shipping-bar--qualified .cart-drawer__shipping-progress-fill {
    background: rgb(var(--color-success));
  }

  .cart-drawer__shipping-checkmark {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    color: rgb(var(--color-success));
  }

  .cart-drawer__items {
    display: flex;
    flex-direction: column;
    padding-inline: var(--cart-drawer-padding);
    overflow-y: auto;

    @media screen and (min-width: 750px) {
      padding-inline: var(--cart-drawer-padding-desktop);
    }
  }

  .cart-drawer__items .cart-items__table-row {
    padding-bottom: var(--gap-xl);
    border-bottom: var(--style-border-width) solid var(--color-border);
    margin-bottom: var(--gap-xl);
  }

  .cart-drawer__items .cart-items__table-row:last-child {
    border-bottom: none;
    padding-block-end: 0;
    margin-block-end: 0;
  }

  .cart-drawer--empty .cart-drawer__inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100dvh;
    margin-top: 0;
  }

  .cart-drawer:not(:has(.cart-form)) .cart-drawer__content {
    justify-content: center;
  }

  .cart-drawer__header {
    background-color: var(--color-background);
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: var(--cart-drawer-padding);
    border-bottom: var(--style-border-width) solid none;
    position: sticky;
    top: 0;
    z-index: 1;

    @media screen and (min-width: 750px) {
      padding: var(--cart-drawer-padding-desktop);
    }
  }

  .cart-drawer--empty .cart-drawer__header {
    justify-content: right;
    border-bottom: none;
    padding-bottom: 0;
  }

  .cart-drawer--empty .cart-drawer__heading {
    text-align: center;
  }

  .cart-drawer:not(:has(.cart-form)) .cart-items__wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  header-actions {
    display: flex;

    @media screen and (max-width: 749px) {
      justify-self: flex-end;
    }
  }

  .header__column--right header-actions {
    margin-inline-start: calc(var(--gap-md) * -1);
  }

  .header-actions__action {
    --button-color: var(--color-foreground);

    cursor: pointer;
    display: flex;
    justify-content: center;
  }

  .header-actions__action .svg-wrapper {
    height: var(--button-size);
    width: var(--button-size);
  }

  .header-actions__action svg {
    width: var(--icon-size-md);
    height: var(--icon-size-md);
  }

  .header-actions__cart-icon {
    --cart-bubble-size: 20px;
    --cart-bubble-top: 4.5px;
    --cart-bubble-right: 2.5px;

    position: relative;
  }

  .header-actions__cart-icon .cart-bubble {
    position: absolute;
    width: var(--cart-bubble-size, 20px);
    top: var(--cart-bubble-top);
    right: var(--cart-bubble-right);
  }

  .cart-drawer__heading .cart-bubble {
    width: fit-content;
    border-radius: var(--style-border-radius-buttons-primary);
    aspect-ratio: auto;
    padding: var(--cart-padding);
  }

  .cart-drawer__heading .cart-bubble[data-maintain-ratio] {
    aspect-ratio: 1;
    min-width: 26px;
  }

  .header-actions__cart-icon .cart-bubble__text,
  .cart-drawer__heading .cart-bubble__text {
    font-family: var(--font-paragraph--family);
    font-weight: var(--font-paragraph--weight);
  }

  .header-actions__cart-icon.header-actions__cart-icon--has-cart svg {
    /* Create donut mask where the cart bubble sits */
    mask: radial-gradient(
      calc(var(--cart-bubble-size) + 2px) at calc(100% - var(--cart-bubble-right)) var(--cart-bubble-top),
      transparent 45.45%,
      #fff 45.45%,
      #fff 100%
    );
  }

  .cart-drawer__heading .cart-bubble__background {
    background-color: rgb(var(--color-foreground-rgb) / var(--opacity-10-25));
  }

  .cart-drawer__heading .cart-bubble__text {
    color: var(--color-foreground);
    font-size: var(--font-size--xs);
  }

  .cart-bubble--animating .cart-bubble__background {
    animation: grow var(--animation-speed) var(--animation-easing);
  }

  .cart-bubble--animating .cart-bubble__text {
    --start-y: -1em;
    --start-opacity: 1;
    /* Set initial transform state before animation starts */
    transform: translate(0, var(--start-y, -1em));
    opacity: var(--start-opacity, 1);
    animation: move-and-fade var(--animation-speed) var(--animation-easing);
  }

  cart-icon:has(.cart-bubble__text-count:empty) {
    --cart-bubble-size: 10px;
    --cart-bubble-top: 9px;
    --cart-bubble-right: 9px;

    .svg-wrapper {
      --cart-bubble-top: 4px;
      --cart-bubble-right: 4px;
    }
  }

  /* Hide Shopify subscription/recurring purchase disclosure in cart drawer */
  .cart-drawer shopify-payment-terms,
  .cart-drawer__summary shopify-payment-terms {
    display: none !important;
  }

  /* Hide app embed shipping bar when inside cart drawer */
  .cart-drawer #free-shipping-bar,
  cart-drawer-component #free-shipping-bar {
    display: none !important;
  }
{% endstylesheet %}

{% comment %} Free Shipping Bar JavaScript for Cart Drawer {% endcomment %}
<script>
(function() {
  'use strict';
  
  {% assign shipping_threshold = shop.metafields.shipping.free_threshold | default: 50 %}
  {% assign shipping_message = shop.metafields.shipping.message | default: 'Add {amount} more for free shipping!' %}
  {% assign shipping_success_message = shop.metafields.shipping.success_message | default: 'You qualify for free shipping!' %}
  
  const threshold = {{ shipping_threshold }};
  const messageTemplate = {{ shipping_message | json }};
  const successMessage = {{ shipping_success_message | json }};
  
  function formatMoney(cents) {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(cents / 100);
  }
  
  async function getCart() {
    try {
      const response = await fetch('/cart.js');
      return await response.json();
    } catch (error) {
      console.log('Cart drawer shipping: Error fetching cart', error);
      return null;
    }
  }
  
  function updateCartDrawerShippingBar() {
    const shippingBar = document.getElementById('cart-drawer-shipping-bar');
    const progressFill = document.getElementById('cart-shipping-progress-fill');
    const messageEl = document.getElementById('cart-shipping-message');
    
    if (!shippingBar || !progressFill || !messageEl) {
      return; // Elements not in DOM yet
    }
    
    getCart().then(cart => {
      if (!cart || cart.items.length === 0) {
        shippingBar.style.display = 'none';
        return;
      }
      
      const cartTotal = cart.items
        .filter(item => !item.properties || (!item.properties._gift && !item.properties._gift_rule_id))
        .reduce((sum, item) => sum + (item.line_price / 100), 0);
      
      const remaining = Math.max(0, threshold - cartTotal);
      const percentage = Math.min(100, (cartTotal / threshold) * 100);
      
      shippingBar.style.display = 'block';
      
      if (cartTotal >= threshold) {
        shippingBar.classList.add('cart-drawer__shipping-bar--qualified');
        messageEl.className = 'cart-drawer__shipping-message cart-drawer__shipping-message--qualified';
        messageEl.innerHTML = `
          <svg class="cart-drawer__shipping-checkmark" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16.7071 5.29289C17.0976 5.68342 17.0976 6.31658 16.7071 6.70711L8.70711 14.7071C8.31658 15.0976 7.68342 15.0976 7.29289 14.7071L3.29289 10.7071C2.90237 10.3166 2.90237 9.68342 3.29289 9.29289C3.68342 8.90237 4.31658 8.90237 4.70711 9.29289L8 12.5858L15.2929 5.29289C15.6834 4.90237 16.3166 4.90237 16.7071 5.29289Z" fill="currentColor"/>
          </svg>
          <span>${successMessage}</span>
        `;
        progressFill.style.width = '100%';
        progressFill.style.background = 'rgb(var(--color-success))';
      } else {
        shippingBar.classList.remove('cart-drawer__shipping-bar--qualified');
        messageEl.className = 'cart-drawer__shipping-message';
        const formattedAmount = formatMoney(remaining * 100);
        messageEl.textContent = messageTemplate.replace('{amount}', formattedAmount);
        progressFill.style.width = `${percentage}%`;
        progressFill.style.background = 'rgb(var(--color-button))';
      }
      
      // Hide app embed shipping bar if it exists in cart drawer
      const appEmbedBar = document.querySelector('.cart-drawer #free-shipping-bar, cart-drawer-component #free-shipping-bar');
      if (appEmbedBar) {
        appEmbedBar.style.display = 'none';
      }
    }).catch(error => {
      console.log('Cart drawer shipping: Error updating bar', error);
    });
  }
  
  // Wait for DOM to be ready
  function init() {
    // Initial update after a short delay to ensure elements exist
    setTimeout(updateCartDrawerShippingBar, 100);
    
    // Listen for cart updates
    document.addEventListener('cart:update', updateCartDrawerShippingBar);
    document.addEventListener('cart:updated', updateCartDrawerShippingBar);
    document.addEventListener('cart:change', updateCartDrawerShippingBar);
    document.addEventListener('cart:refresh', updateCartDrawerShippingBar);
    
    // Also update when cart drawer opens
    const cartDrawer = document.querySelector('cart-drawer-component');
    if (cartDrawer) {
      cartDrawer.addEventListener('dialog:opened', () => {
        setTimeout(updateCartDrawerShippingBar, 100);
      });
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  // Hide subscription disclosure in cart drawer
  function hideSubscriptionDisclosure() {
    const cartDrawer = document.querySelector('.cart-drawer, cart-drawer-component');
    if (cartDrawer) {
      const paymentTerms = cartDrawer.querySelectorAll('shopify-payment-terms');
      paymentTerms.forEach(el => {
        el.style.display = 'none';
        if (el.shadowRoot) {
          const style = document.createElement('style');
          style.textContent = '* { display: none !important; }';
          el.shadowRoot.appendChild(style);
        }
      });
      
      // Hide any elements containing disclosure text
      const allElements = cartDrawer.querySelectorAll('*');
      allElements.forEach(el => {
        const text = el.textContent || '';
        if (text.includes('recurring or deferred purchase') || 
            text.includes('cancellation policy') ||
            text.includes('authorize you to charge my payment method')) {
          el.style.display = 'none';
        }
      });
    }
  }
  
  // Hide disclosure when cart drawer opens
  const cartDrawerComponent = document.querySelector('cart-drawer-component');
  if (cartDrawerComponent) {
    cartDrawerComponent.addEventListener('dialog:opened', () => {
      setTimeout(hideSubscriptionDisclosure, 100);
    });
  }
  
  // Watch for cart updates
  document.addEventListener('cart:update', hideSubscriptionDisclosure);
  document.addEventListener('cart:updated', hideSubscriptionDisclosure);
  
  // Use MutationObserver for cart drawer
  const drawerObserver = new MutationObserver(() => {
    hideSubscriptionDisclosure();
  });
  
  const drawerElement = document.querySelector('.cart-drawer, cart-drawer-component');
  if (drawerElement) {
    drawerObserver.observe(drawerElement, {
      childList: true,
      subtree: true
    });
  }
})();
</script>
